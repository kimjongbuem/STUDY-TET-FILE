TCP 프로토콜 9장
<1>
전송계층은 오류제어, 흐름제어, 데이터 순서화 등에서는 데이터링크계층과 유사. BUT 데이터 링크계층은 물리적 전송 선로로 직접 연결된 호스트 사이의 데이터 전송을 담당.
전송계층은 네트워크 끝단에 위치하는 통신 주체가 중간의 논리적인 선로를 통하여 데이터를 송수신. ->논리적 네트워크의 중개 기능을 사용하여, 전송 기능을 수행함.

전송계층의 주요 기능
1. 흐름제어 2. 오류제어 3. 분할과 병합(세그멘테이션) 4. 서비스 프리미티브

전송계층 설계시 고려사항.
1. 주소. TSAP 트랜스서비스액세스포인터 -> 구조적 : 대한민국/서울시/성북동.../비구조적. /IP ADDRESS
2. 멀티플렉싱(TPDU) : 특정노드에 통신해야할 프로세스를 뭉쳐서.. 세션계층 TSAP/ 전송계층 /네트워크 계층 NSAP TSAP(MUL) -> NSAP 상방향, TSAP <- NSAP(MUL) 하방향.-> 우체통 정도생각.
3. 연결설정 ; 이따 자세히..
Conn_Req , Conn_ACK의 회신으로 완료 
4. 연결해제
	1) 일방적 연결 해제 절차 방식 : 통신하는 한쪽 프로세스가 일방적으로 DISC_Req를 전송해 연결 종료를 선언가능. Ongoing data 끝나면 더이상 보낼 데이터가 있냐고 물어보고 no -> finish 합의
	2) 점진적 연결 해제 절차 방식: 하나의 연결에 두개의 단방향 연결을 지원하는 원통이 존재한다고 생각해. 따라서 두개의 원통을 명시적으로 정지해야 한다.(DISC_Req)
<2>
TCP 프로토콜 - 가상회선 비연결형이니까.. 신뢰성있는 데이터 전송방식인데, OS내부기능으로 구현되니 TCP 서비스 이용하려면 상위계층에서 시스템 콜이라는 프로그램 호출방식사용.
유닉스 환경에서는 소켓 프로그래밍.
IP 프로토콜 위에서 연결형 서비스를 지원하는 전송 계층 프로토콜.

TCP 헤더구조)
20 바이트 최소.
SOURCE PORT / DESTINATION PORT 16 16
Sequnce Number 32  / Acknowlegment Number 32
Data Offset Reserved [cwr ece ack urg psh rst syn fin] Window
CheckSum / Urgent Point
Option / padding ( 생략가능)

S/D port : Tcp로 연결되는 가상 회선 양단의 송수신 프로세스에 할당된 네트워크 주소야. 포트 : 프로세스에 할당되는 네트워크 자원. 이 포트를 구분하기 위한 주소가 포트번호야. 
포트번호는 독립적인 주소이기 때문에 UDP , TCP 둘다 별도의 주소를 가지기 때문에 같은 포트번호를 부여 받아도 괜찮아요.(독립적)
Sequence Numser : 송신 프로세스가 지정하는 순서번호임, 세그먼트 전송과정에서 전송되는 바이트의 수를 기준으로 증가합니다.
Acknowledgement Number(응답 번호) ;: 수신 프로세스가 제대로 수신한 바이트의 수를 응답하기 위해 사용함. 연결설정이나 연결해제처럼 데이터 세그먼트가 없는 경우에도 순서번호가 1씩 증가하는 점 유의하자.
올바로 수신한 데이터의 마지막 번호 표기하자!!
DataOffset : TCP 세그먼트가 시작되는 위치를 기준으로 데이터의 시작 위치를 나타냄.(TCP 헤더 크기가 됩니다..) / Rserved : 예약필드..
Window : 흐름제어, 슬라이딩 윈도우 프로토콜 , 데이터를 더 이상 수신할 수 없으면 Window 필드 값 0 지정.
Checksum : 변형오류 검출 
Urgent Pointer : 긴급 데이터를 처리하기 위한 것. urg 플래그 비트가 지정 유효. SequnceNumber < SequnceNumber+ UrgentPointer 긴급 데이터 전송.

플래그 비트 : 
cwr, ece (혼잡제어)
ECN 기능을 사용하기 위해서 위 2 플래그 비트를 사용한다.
CWR : ECE 비트를 수신한 송신 프로세스가 전송 윈도우의 크기를 줄였음을 통지하는 것이 목적. 즉 ECE를 전송하지 말라고 하는 의미임.
ECE : 네트워크 트래픽이 많아져서 라우터가 송신 프로세스에 명시적으로 혼잡을 알릴려고 할 때 사용한다.
urg : Urgent Pointer가 유효한지 나타냄.
ack : Acknowledgment Number 필드가 유효한지 ㅇ=나타냄. 
psh : 현재 세그먼트에 포함된 데이터를 상위 계층에 즉시 전달하도록 지시.
rst : 연결의 리셋이나 유효하지 않은 세그먼트에 대한 응답용.
syn : 연결설정 요구를 의미하는 플래그 비트다. // 가상회선 연결 설정이다.
fin : 한쪽 프로세스에서 더는 전송할 데이터 가 없어서 종료를 하고싶다는 의사를 표시하는 플래그 비트.

포트번호)
TCP/UDP가 상위계층에 제공하는 주소 표현 방식임.
클라->서버 연동은 서버가 먼저 실행되고 클라가 서버와 연결을 시도하는 방식으로 이루어짐.
인터넷 환경에서 많이 사용하는 네트워크 응용 서비스의 서버 프로세스에 할당된 포트 번호 : Well - known 포트

<3>
TCP 프로토콜을 이용한 데이터 전송
전이중 방식 사용해 양방향 통신을 지원. 가상회신, 피기배킹

1. 연결설정
3단계 설정방식을 사용함. (프로세스들 A-> B로 연결설정 요구)
A --(Seq 10 , SYN)--> B   A <--(Seq 50 , ACK 11 , SYN, ACK)-- B   A --(Seq 11 , ACK 51,  ACK)--> B 

2. 데이터 전송
TCP는 데이터 전송 과정에서 흐름제어를 지원하는 슬라이딩 윈도우 프로토콜을 사용함. 데이터를 수신하는 프로세스는 세그먼트 헤더의 WINDOW 필드를 이용해 윈도우의 크기를 늘리거나 줄여 전송속도 조절.
전이중 방식, 피기배킹.
A --(Seq 11 , ACK 51, ACK, DATA =5)--> B   A <--(Seq 51 , ACK 16, ACK ,DATA =10)-- B   A --(Seq 16 , ACK  61, ACK )--> B
근데 데이터 전송오류가 발생하면??
TCP 데이터를 세그먼트라 함. -순서번호이용 TCP는 NAK 사용을 안하고 ACK비트를 이용한 SET OR 타임아웃 기능에 의해 오류 복구.(일단대기)
A -- SEQ 11 DATA 10 --> B     A-- SEQ 21 DATA 10 --> B  A-- SEQ 31 DATA 10 --> B   ERROR ==>> A <-- ACK 31, ACK -- B

3. 연결해제
연결을 해제시 연결을 해제하고자 FIN 플래그 비트 지정 요구 , 양쪽의 동의하에 진행되기 때문에 연결 해제 세그먼트를 받은 프로세스가 FIN 플래그로 응답할 때까지 연결 유지.
(SEQ 66 , ACK 17 ACK FIN) , (SEQ 17 ACK 67 ACK)

4. 혼잡제어
ECN 기능은 TCP의 혼잡 제어 기능을 지원하며 TCP연결 설정 단계에서 ECN 사용에 대한 동의 절차를 거쳐야함.
SYN CWR ECE , SYN ACK ECE : 참여.. // SYN CWR ECE , SYN ACK 비참여
TCP 헤더의 CWR 플래그를 지정하여 혼잡에 적절한 조치를 취했음을 통지하자..





























